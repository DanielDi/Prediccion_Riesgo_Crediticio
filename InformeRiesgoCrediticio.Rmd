---
title: "InformeRiesgoCrediticio"
author: "Brayan Ortiz, Juan Peña, Thalea Hesse, Juan Falcon, Daniel Espinal"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(purrr)
library(feather)
library(arrow)
library(scorecard)
library(dplyr)    # alternatively, this also loads %>%
library(ggplot2)
library(klaR)
library(riskR)
library(corrplot)
library(creditmodel)
library(pROC)

knitr::opts_chunk$set(echo = TRUE)
```

## Lectura de los datos

```{r setup, include=FALSE}

df = arrow::read_feather("datos_juntos.feather")

# Delete cols with more than 50% with NAs
df <- subset(df, select = c(-tot_coll_amt, -tot_cur_bal, -total_rev_hi_lim))

# Solo tienen valores en 0
df <- subset(df, select = c(-collections_12_mths_ex_med, -acc_now_delinq, 
                            -pymnt_plan, -term))

```

## División de los datos en Entrenamiento y Prueba

```{r, include=FALSE}

tv <- split_df(df, y = "good_bad", ratio = c(0.75, 0.25),
               seed = 42, no_dfs = 2, name_dfs = c("train", "valid"))

train <- tv$train
valid <- tv$valid

```

## Selección de variables predictoras

```{r, include=FALSE}

# Agrupa los datos en bins
bins <- woebin(train, y = "good_bad", method = "tree")

# Aplica los bins al dataset train
train_bins <- woebin_ply(train, bins, to = "bin")
train_woes <- woebin_ply(train, bins)

# Aplica los bins al dataset valid
valid_bins <- woebin_ply(valid, bins, to = "bin")
valid_woes <- woebin_ply(valid, bins)

iv_vars <- feature_selector(dat_train = train_woes, dat_test = NULL, 
                            target = "good_bad", filter = "IV", iv_cp = 0.02,
                            vars_name = FALSE)

var_names <- sub("_woe", "", iv_vars$Feature)
var_names
```

## Filtrar los dataframes con las nuevas variables
```{r, include=FALSE}

train <- subset(train, select = append(var_names, "good_bad"))
train_bins <- subset(train_bins, select = append(paste(var_names, "_bin", sep=""), "good_bad"))
train_woes <- subset(train_woes, select = append(paste(var_names, "_woe", sep=""), "good_bad"))
# bins <- woebin(train, y = "good_bad", method = "tree")

valid <- subset(valid, select = append(var_names, "good_bad"))
valid_bins <- subset(valid_bins, select = append(paste(var_names, "_bin", sep=""), "good_bad"))
valid_woes <- subset(valid_woes, select = append(paste(var_names, "_woe", sep=""), "good_bad"))
```

## Análisis de Agrupamiento en los datos de Entrenamiento


```{r, include=FALSE}

options(digits = 4)
bins$int_rate[, c(2, 4, 5, 6, 7, 8)]

# Visualización de los bins de la variable int_rate
woebin_plot(bins, x = "int_rate", line_value = "woe")
```

## Correlaciones entre variables predictoras
```{r, include=FALSE}
names(train_woes) <- sub("_woe", "", names(train_woes))
corr_train = cor(train_woes)
corrplot(corr_train)
```


## Modelo glm

```{r, include=FALSE}

train_model <- glm(good_bad ~ ., data = train_woes, family = binomial())
summary(train_model)
```

```{r, include=FALSE}
test_pred_mod <- predict(train_model, valid_woes, type = "response")

perf_eva(test_pred_mod, valid_woes$good_bad,
         type = c("roc"))
```

## Logistic Regression into Scorecard

```{r, include=FALSE}
score_card_model <- scorecard(bins, train_model, points0 = 690)
```
Gráfico del scorecard
```{r, include=FALSE}
library(stringr)
```
```{r, include=FALSE}
do.call("bind_rows", score_card_model) %>% 
  slice(-1) %>% 
  #select(-breaks, -is_special_values, -count, -count_distr, -pos, -neg, -posprob) %>% 
  #select(variable, bin, woe, points, bin_iv, total_iv) %>% 
  mutate_if(is.numeric, function(x) {round(x, 3)}) %>% 
  mutate(bin = bin %>% 
           str_replace_all("\\%,%", "_") %>% 
           str_replace_all("\\[", "From ") %>% 
           str_replace_all("\\,", " to ") %>% 
           str_replace_all("\\)", "")) -> iv_for_predictors_point

iv_for_predictors_point %>% 
  knitr::kable()

#col.names = c("Predictor", "Group", "WOE", "Points", "Bin IV", "Total IV")
```

## Predicción de los puntos en datos de Entrenamiento y Validación

```{r, include=FALSE}
train_score_predicted = scorecard_ply(train, score_card_model, 
                                      only_total_score = FALSE)
valid_score_predicted = scorecard_ply(valid, score_card_model, 
                                      only_total_score = FALSE)
```

## Métricas de rendimiento

```{r, include=FALSE}
curve <- roc(valid$good_bad, valid_score_predicted$score,
              direction = ">")
plot(curve)
auc(curve)

gt <- gains_table(valid_score_predicted$score, valid$good_bad, bin_num = 8)
gt[, c(2,4,5,6,7,8,10,11)]
```

